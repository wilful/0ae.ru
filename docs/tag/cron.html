<!DOCTYPE html>
<html lang="en">
<head>
        <title>YODA - cron</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="https://srv-nix.com/theme/css/main.css" type="text/css" />
        <link href="https://srv-nix.com/" type="application/atom+xml" rel="alternate" title="YODA ATOM Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://srv-nix.com/css/ie.css"/>
                <script src="https://srv-nix.com/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://srv-nix.com/css/ie6.css"/><![endif]-->

</head>

<body>
	<div id="wrap" style="width:850px">
	    <div id="container" style="width:560px">


            <div class="entry">
        
        

            <header>
            <h1><a href="https://srv-nix.com" id="site-title">  </a>  <a href="https://srv-nix.com/zapusk-skriptov-s-blokirovkoi-lock-file.html" id="page-title">"Запуск скриптов с блокировкой (lock-file)"</a></h1>
<time datetime="2015-12-02T07:07:46+03:00">Wed 02 December 2015</time>            </header>

            <article>
                <p>Пример скрипта для запуска скриптов с блокировкой из крона</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>

: <span class="si">${</span><span class="nv">2</span><span class="p">?</span><span class="s2">&quot;Not enough parameters. Usage: </span><span class="nv">$FUNCNAME</span><span class="s2"> CMD SCRIPT [PARAMS]&quot;</span><span class="si">}</span>

<span class="nv">BIN</span><span class="o">=</span><span class="k">$(</span>which bash<span class="k">)</span>
<span class="nv">CMD</span><span class="o">=</span><span class="nv">$1</span><span class="p">;</span> <span class="nb">shift</span>
<span class="nv">SCRIPT</span><span class="o">=</span><span class="nv">$1</span><span class="p">;</span> <span class="nb">shift</span>
<span class="nv">SCRIPT_PARAMS</span><span class="o">=</span><span class="nv">$@</span>
<span class="nv">SCRIPT_NAME</span><span class="o">=</span><span class="k">$(</span>basename <span class="nv">$SCRIPT</span><span class="k">)</span>
<span class="o">[[</span> ! <span class="nv">$USER</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">USER</span><span class="o">=</span>nobody
<span class="nv">LOCKDIR</span><span class="o">=</span><span class="s2">&quot;/tmp/locks-</span><span class="nv">$USER</span><span class="s2">&quot;</span>
<span class="nv">STALE_AGE</span><span class="o">=</span><span class="m">4</span> <span class="c1">#hours</span>
<span class="nv">PIDFILE</span><span class="o">=</span><span class="nv">$LOCKDIR</span>/<span class="nv">$SCRIPT_NAME</span>/pid
<span class="nv">LOCKFILE</span><span class="o">=</span><span class="nv">$LOCKDIR</span>/<span class="nv">$SCRIPT_NAME</span>/lock
<span class="nv">LOGFILE</span><span class="o">=</span><span class="nv">$LOCKDIR</span>/<span class="nv">$SCRIPT_NAME</span>/log


fail<span class="o">()</span> <span class="o">{</span> <span class="nb">local</span> <span class="nv">m</span><span class="o">=</span><span class="nv">$1</span><span class="p">;</span> <span class="nb">echo</span> <span class="nv">$m</span> <span class="m">1</span>&gt;<span class="p">&amp;</span><span class="m">2</span> <span class="o">&amp;&amp;</span> <span class="nb">exit</span> <span class="m">1</span><span class="p">;</span> <span class="o">}</span>
clean<span class="o">()</span> <span class="o">{</span> <span class="nb">local</span> <span class="nv">f</span><span class="o">=</span><span class="nv">$1</span><span class="p">;</span> rm -rf <span class="nv">$f</span><span class="p">;</span> <span class="o">}</span>

<span class="o">[[</span> ! -d <span class="si">${</span><span class="nv">LOCKDIR</span><span class="si">}</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
    <span class="k">if</span> ! mkdir <span class="si">${</span><span class="nv">LOCKDIR</span><span class="si">}</span> <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">&amp;</span>&gt;/dev/null<span class="p">;</span> <span class="k">then</span>
        fail <span class="s2">&quot;[</span><span class="k">$(</span>date +%s<span class="k">)</span><span class="s2">]: Can&#39;t create locks dir [</span><span class="nv">$LOCKDIR</span><span class="s2">]&quot;</span>
    <span class="k">fi</span>

<span class="k">if</span> mkdir <span class="nv">$LOCKDIR</span>/<span class="nv">$SCRIPT_NAME</span> <span class="p">&amp;</span>&gt; /dev/null<span class="p">;</span> <span class="k">then</span>
    <span class="nb">eval</span> <span class="s2">&quot;</span><span class="nv">$CMD</span><span class="s2"> </span><span class="nv">$SCRIPT</span><span class="s2"> </span><span class="nv">$SCRIPT_PARAMS</span><span class="s2"> &amp;&quot;</span>  <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">&amp;</span>&gt;<span class="nv">$LOGFILE</span> <span class="c1">#\</span>
        <span class="o">||</span> fail <span class="s2">&quot;Error while starting script </span><span class="nv">$SCRIPT</span><span class="s2">&quot;</span>
    <span class="nv">PID</span><span class="o">=</span><span class="nv">$!</span>
    <span class="nb">echo</span> <span class="nv">$!</span>&gt;<span class="nv">$PIDFILE</span>
    touch <span class="nv">$LOCKFILE</span>
    <span class="k">if</span> <span class="nb">wait</span> <span class="s2">&quot;</span><span class="nv">$PID</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;[</span><span class="k">$(</span>date +%s<span class="k">)</span><span class="s2">]: Success&quot;</span> <span class="p">&amp;</span>&gt;<span class="nv">$LOGFILE</span>
        clean <span class="nv">$LOCKDIR</span>/<span class="nv">$SCRIPT_NAME</span>
    <span class="k">else</span>
        fail <span class="s2">&quot;[</span><span class="k">$(</span>date +%s<span class="k">)</span><span class="s2">]: Something went wrong, see log: </span><span class="nv">$LOGFILE</span><span class="s2">&quot;</span>
    <span class="k">fi</span>
    <span class="nb">exit</span> <span class="m">0</span>
<span class="k">else</span>
    <span class="nv">PID</span><span class="o">=</span><span class="k">$(</span>cat <span class="nv">$PIDFILE</span><span class="k">)</span>
    <span class="k">if</span> ! <span class="nb">kill</span> -s <span class="m">0</span> <span class="nv">$PID</span> <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">&amp;</span>&gt;/dev/null<span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;[</span><span class="k">$(</span>date +%s<span class="k">)</span><span class="s2">]: Process not found, try to restarting </span><span class="nv">$SCRIPT</span><span class="s2">&quot;</span> <span class="m">1</span>&gt;<span class="p">&amp;</span><span class="m">2</span>
        clean <span class="nv">$LOCKDIR</span>/<span class="nv">$SCRIPT_NAME</span>
        <span class="nv">$BIN</span> <span class="nv">$0</span> <span class="nv">$CMD</span> <span class="nv">$SCRIPT</span> <span class="nv">$SCRIPT_PARAMS</span> <span class="o">&amp;&amp;</span>
            <span class="nb">exit</span> <span class="m">0</span>
        fail <span class="s2">&quot;[</span><span class="k">$(</span>date +%s<span class="k">)</span><span class="s2">]: Can&#39;t to start script </span><span class="nv">$SCRIPT</span><span class="s2">&quot;</span>
    <span class="k">else</span>
        <span class="nb">echo</span> <span class="s2">&quot;[</span><span class="k">$(</span>date +%s<span class="k">)</span><span class="s2">]: Process already run with pid </span><span class="nv">$PID</span><span class="s2">&quot;</span> <span class="p">&amp;</span>&gt;&gt;<span class="nv">$LOGFILE</span>
    <span class="k">fi</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="k">$(($(</span>date +%s<span class="k">)</span> <span class="o">-</span> <span class="k">$(</span>stat -c %Y <span class="nv">$LOCKFILE</span><span class="k">)</span> <span class="k">))</span> -gt <span class="k">$((</span> <span class="nv">$STALE_AGE</span> <span class="o">*</span><span class="m">60</span> <span class="o">*</span><span class="m">60</span> <span class="k">))</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;[</span><span class="k">$(</span>date +%s<span class="k">)</span><span class="s2">]: File </span><span class="nv">$LOCKFILE</span><span class="s2"> staled, try to restart script </span><span class="nv">$SCRIPT</span><span class="s2">&quot;</span> <span class="m">1</span>&gt;<span class="p">&amp;</span><span class="m">2</span>
        <span class="nb">echo</span> <span class="s2">&quot;[</span><span class="k">$(</span>date +%s<span class="k">)</span><span class="s2">]: killing </span><span class="nv">$PID</span><span class="s2">&quot;</span> <span class="m">1</span>&gt;<span class="p">&amp;</span><span class="m">2</span>
        <span class="k">if</span> ! <span class="nb">kill</span> -15 <span class="nv">$PID</span> <span class="p">&amp;</span>&gt; /dev/null<span class="p">;</span> <span class="k">then</span>
            fail <span class="s2">&quot;[</span><span class="k">$(</span>date +%s<span class="k">)</span><span class="s2">]: Can&#39;t killing process with pid </span><span class="nv">$PID</span><span class="s2">&quot;</span>
        <span class="k">fi</span>
        <span class="nb">echo</span> <span class="s2">&quot;[</span><span class="k">$(</span>date +%s<span class="k">)</span><span class="s2">]: Removing stale lock folder: </span><span class="nv">$LOCKDIR</span><span class="s2">/</span><span class="nv">$SCRIPT_NAME</span><span class="s2">&quot;</span> <span class="m">1</span>&gt;<span class="p">&amp;</span><span class="m">2</span>
        clean <span class="nv">$LOCKDIR</span>/<span class="nv">$SCRIPT_NAME</span>
        <span class="nv">$BIN</span> <span class="nv">$0</span> <span class="nv">$CMD</span> <span class="nv">$SCRIPT</span> <span class="nv">$SCRIPT_PARAMS</span>
    <span class="k">fi</span>
<span class="k">fi</span>
</code></pre></div><p>There are <a href="https://srv-nix.com/zapusk-skriptov-s-blokirovkoi-lock-file.html#disqus_thread">comments</a>.</p>            </article>
            </div>
        </div>


        <div id="sidebar">
            <h1><a href="https://srv-nix.com " title="title">YODA</a></h1>
            <span class="description"> </span>
            <!-- <span class="feed"><a href="">RSS</a> | <a href="">Atom</a></span> -->
        </div>

        <div id="footer">
            <nav>
                <ul>
                    <li>:: <a href="https://srv-nix.com/categories.html">Categories</a></li>
                    <li>:: <a href="https://srv-nix.com/tags.html">Tags</a></li>
                </ul>
            </nav>

            <div id="credits">
                <span>Adapted from <a href="http://wordpress.org/themes/monospace">Monospace</a> || Created with <a href="">Pelican</a></span>
            </div>
                
        </div>

<script type="text/javascript">
    var disqus_shortname = 'srv-nix-com';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

    </div>

</body>
</html>