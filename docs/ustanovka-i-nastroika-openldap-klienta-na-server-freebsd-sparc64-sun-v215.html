<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="generator" content="Pelican" />
        <title>"Установка и настройка OpenLDAP клиента на сервер FreeBSD (Sparc64 Sun v215)"</title>
        <link rel="stylesheet" href="https://srv-nix.com/theme/css/main.css" />
        <meta name="description" content="Чего меньше всего ожидаешь, работая системным администратором? Правильно! Того, что после первой установки придется еще 3 раза разворачивать..." />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://srv-nix.com/">YODA</a></h1>
                <nav><ul>
                    <li class="active"><a href="https://srv-nix.com/category/freebsd.html">freebsd</a></li>
                    <li><a href="https://srv-nix.com/category/games.html">games</a></li>
                    <li><a href="https://srv-nix.com/category/linux.html">linux</a></li>
                    <li><a href="https://srv-nix.com/category/macos.html">MacOS</a></li>
                    <li><a href="https://srv-nix.com/category/other.html">other</a></li>
                    <li><a href="https://srv-nix.com/category/shell.html">shell</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="https://srv-nix.com/ustanovka-i-nastroika-openldap-klienta-na-server-freebsd-sparc64-sun-v215.html" rel="bookmark"
           title="Permalink to "Установка и настройка OpenLDAP клиента на сервер FreeBSD (Sparc64 Sun v215)"">"Установка и настройка OpenLDAP клиента на сервер FreeBSD (Sparc64 Sun v215)"</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2014-03-27T00:32:20+06:00">
                Published: Thu 27 March 2014
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://srv-nix.com/author/a-semenov.html">A. Semenov</a>
        </address>
<p>In <a href="https://srv-nix.com/category/freebsd.html">freebsd</a>.</p>
<p>tags: <a href="https://srv-nix.com/tag/freebsd.html">freebsd</a> <a href="https://srv-nix.com/tag/openldap.html">openldap</a> </p>
</footer><!-- /.post-info -->      <p>Чего меньше всего ожидаешь, работая системным администратором? Правильно! Того, что после первой установки придется еще 3 раза разворачивать FreeBSD на Sun v215 5-6 летней давности, удалённо, без доступа к KVM. Поэтому оставлю тут куски трудов для памятки. </p>
<p>Для подключения к OpenLDAP серверу нам нужны следующие порты: security/pam_mkhomedir security/pam_ldap net/nss_ldap</p>
<div class="highlight"><pre><span></span><code>make install clean -C /usr/ports/security/pam_mkhomedir
make install clean -C /usr/ports/security/pam_ldap
</code></pre></div>

<p>При сборке ядра я отключил поддержку WITHOUT_KERBEROS=yes, по-этому 
для сборки net/nss_ldap порта FreeBSD под архитектуру sparc64 нужно исходники пропатчить</p>
<div class="highlight"><pre><span></span><code>cp -R /usr/ports/net/nss_ldap/ /usr/local/src/nss_ldap/
</code></pre></div>

<p>Сам патч выглядит так:</p>
<div class="highlight"><pre><span></span><code>cat /root/nss.patch
<span class="gh">diff -u -r /usr/ports/net/nss_ldap/Makefile /usr/local/src/nss_ldap/Makefile</span>
<span class="gi">+++ /home/bakhtin/work/nss_ldap/Makefile    2009-04-03 20:01:18.000000000 +0400</span>
<span class="gu">@@ -33,8 +33,7 @@</span>
 CONFIGURE_ARGS=  --with-ldap-conf-file=${PREFIX}/etc/nss_ldap.conf \
            --with-ldap-secret-file=${PREFIX}/etc/nss_ldap.secret \
                --enable-rfc2307bis \
<span class="gd">-         --enable-paged-results \</span>
<span class="gd">-              --enable-configurable-krb5-ccname-env</span>
<span class="gi">+         --enable-paged-results</span>

 MAN5=        nss_ldap.5

<span class="gh">diff -u -r /usr/ports/net/nss_ldap/files/patch-ldap-nss.c  /usr/local/src/nss_ldap/files/patch-ldap-nss.c</span>
<span class="gi">+++ /home/bakhtin/work/nss_ldap/files/patch-ldap-nss.c      2009-04-03 20:00:30.000000000 +0400</span>
<span class="gu">@@ -9,3 +9,11 @@</span>
  #include 
  #elif defined(HAVE_SASL_H)
  #include 
<span class="gi">+@@ -84,7 +84,7 @@</span>
<span class="gi">+ #include </span>
<span class="gi">+ #include </span>
<span class="gi">+ #endif</span>
<span class="gi">+-#ifdef CONFIGURE_KRB5_CCNAME</span>
<span class="gi">++#if defined(CONFIGURE_KRB5_CCNAME) &amp;&amp; defined(HAVE_KRB5_H)</span>
<span class="gi">+ #include </span>
<span class="gi">+ #endif</span>
</code></pre></div>

<p>Зашиваем "заплатку"</p>
<div class="highlight"><pre><span></span><code>patch &lt; /root/nss.patch
</code></pre></div>

<p>И наконец, собираем и устанавливаем порт</p>
<div class="highlight"><pre><span></span><code>make install clean -C /usr/local/src/nss_ldap
</code></pre></div>

<p>Правим файл конфигурации /usr/local/etc/nss_ldap.conf
Сам файл достаточно хорошо документирован, так же есть информация в <a href="http://www.freebsd.org/doc/en/articles/ldap-auth/client.html">handbook</a> <a href="http://www.freebsd.org/doc/ru/books/handbook/">ещё</a></p>
<div class="highlight"><pre><span></span><code>vim /usr/local/etc/nss_ldap.conf
</code></pre></div>

<p>Приведу примеры основных директив</p>
<div class="highlight"><pre><span></span><code>base o=,c=ru
uri ldap://ldap..ru/
pam_groupdn cn=,ou=,ou=,o=,c=ru
pam_member_attribute uniqueMember
pam_password md5
sudoers_base ou=sudoers,ou=,ou=,o=,c=ru
sudoers_debug 0
</code></pre></div>

<p>На всякий случай создаю симлинк для файла конфигурации, некоторые приложения ищут его именно по этому пути</p>
<div class="highlight"><pre><span></span><code>ln -s /usr/local/etc/nss_ldap.conf /usr/local/etc/ldap.conf
</code></pre></div>

<p>Настраиваем сервис pam для подключения  к SSH серверу</p>
<div class="highlight"><pre><span></span><code>vim /etc/pam.d/sshd
</code></pre></div>

<p>Добавим в файл следующие строки</p>
<div class="highlight"><pre><span></span><code>auth        sufficient  /usr/local/lib/pam_ldap.so no_warn
account     sufficient  /usr/local/lib/pam_ldap.so debug
session     sufficient  /usr/local/lib/pam_ldap.so
session     required    /usr/local/lib/pam_mkhomedir.so  debug umask=0077 skel=/usr/local/share/skel
password    required    /usr/local/lib/pam_ldap.so  no_warn try_first_pass
</code></pre></div>

<p>Заставляем систему использовать все наши настройки</p>
<div class="highlight"><pre><span></span><code>vim /etc/nsswitch.conf
</code></pre></div>

<p>Замечание: Настройки связанные с sudoers необходимы только если на сервере LDAP есть схема с настройками sudoers</p>
<div class="highlight"><pre><span></span><code><span class="n">group</span><span class="o">:</span> <span class="n">files</span> <span class="n">cache</span> <span class="n">ldap</span>
<span class="n">passwd</span><span class="o">:</span> <span class="n">files</span> <span class="n">cache</span> <span class="n">ldap</span>
<span class="n">sudoers</span><span class="o">:</span> <span class="n">ldap</span>
</code></pre></div>

<p>ЗКЩААШЕ?</p>
    </div><!-- /.entry-content -->
    <div class="comments">
      <h2>Comments !</h2>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_shortname = 'srv-nix-com';
        var disqus_identifier = 'ustanovka-i-nastroika-openldap-klienta-na-server-freebsd-sparc64-sun-v215.html';
        var disqus_url = 'https://srv-nix.com/ustanovka-i-nastroika-openldap-klienta-na-server-freebsd-sparc64-sun-v215.html';
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//srv-nix-com.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
      <noscript>Please enable JavaScript to view the comments.</noscript>
    </div>

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'srv-nix-com';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>