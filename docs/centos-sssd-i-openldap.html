<!DOCTYPE html>
<html lang="en">
<head>
        <title>YODA : "CentOS. SSSD и OpenLDAP"</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="https://srv-nix.com/theme/css/main.css" type="text/css" />
        <link href="https://srv-nix.com/" type="application/atom+xml" rel="alternate" title="YODA ATOM Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://srv-nix.com/css/ie.css"/>
                <script src="https://srv-nix.com/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://srv-nix.com/css/ie6.css"/><![endif]-->

</head>

<body>
	<div id="wrap" style="width:850px">
	    <div id="container" style="width:560px">


            <div class="entry">
        
<header>
<h1><a href="https://srv-nix.com" id="site-title">  </a>         <a href="https://srv-nix.com/centos-sssd-i-openldap.html" id="page-title">"CentOS. SSSD и OpenLDAP"</a></h1>
<time datetime="2014-03-21T09:00:00+00:00">Fri 21 March 2014</time></header>
<article>
    <p>В [предыдущем][l01] топике я показал, как можно быстро настроить ваш сервер OpenLDAP на использование TLS соединений, чтобы наши враги не могли получить сведения из трафика между сервером и клиентом. В дополнении хотелось бы продемонстрировать настройку групповых политик доступа на сервер под управлением CentOS 6. В качестве клиента будем использовать демона SSSD, который начиная с 6.4 ветки стал сервисом аутентификации по умолчанию.</p>
<p>Я не являюсь специалистом в LDAP и по этому моя конфигурации DIT не была стандартизирована, как хотелось бы, она в целом напоминает <a href="http://www.padl.com/~lukeh/rfc2307bis.txt">RFC2307bis</a> с небольшими изменениями в группах. Ниже будет понятно в чем отличия, хотя они совершенно не критичные.
Если вы используете сторонние репозитории или свои сборки, то необходимо убедиться, что OpenLDAP собран с поддержкой memberOf. Это необходимо для того, чтобы мы могли с помощью фильтра демона sssd разграничивать доступ на сервер. Сам атрибут является динамическим и создается в момент обновления сведений о пользователях и группах на сервере.</p>
<h2>Конфигурация сервера:</h2>
<p>Чтобы активировать модуль нужно добавить в slapd.conf следующее</p>
<h1>Загружаем наложение</h1>
<div class="highlight"><pre><span></span><code><span class="n">moduleload</span>      <span class="n">memberof</span><span class="o">.</span><span class="n">la</span>
</code></pre></div>

<h1>После инициализации БД указываем наш оверлей и дополнительные опции (man slapo-memberof)</h1>
<div class="highlight"><pre><span></span><code>overlay                 memberof
memberof-group-oc       groupOfUniqueNames
memberof-member-ad      uniqueMember
</code></pre></div>

<p>Замечание: memberof-group-oc и memberof-member-ad я указал именно потому, что конфигурация дерева на сервере у меня отличается от стандартной. По умолчанию наложение использует класс объекта группы groupOfNames и ждет, что участники групп хранятся в атрибуте member.
Вот так выглядит рабочий конфиг на моем тестовом окружении</p>
<div class="highlight"><pre><span></span><code><span class="c1"># cat slapd.conf</span>
<span class="n">include</span>         <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openldap</span><span class="o">/</span><span class="n">schema</span><span class="o">/</span><span class="n">core</span><span class="o">.</span><span class="n">schema</span>
<span class="n">include</span>         <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openldap</span><span class="o">/</span><span class="n">schema</span><span class="o">/</span><span class="n">cosine</span><span class="o">.</span><span class="n">schema</span>

<span class="n">TLSCertificateFile</span>      <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openldap</span><span class="o">/</span><span class="n">cacerts</span><span class="o">/</span><span class="n">ldapscert</span><span class="o">.</span><span class="n">pem</span>
<span class="n">TLSCertificateKeyFile</span>   <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openldap</span><span class="o">/</span><span class="n">cacerts</span><span class="o">/</span><span class="n">keys</span><span class="o">/</span><span class="n">ldapskey</span><span class="o">.</span><span class="n">pem</span>
<span class="n">TLSCipherSuite</span> <span class="n">TLSv1</span><span class="o">+</span><span class="n">RSA</span><span class="p">:</span><span class="o">!</span><span class="n">NULL</span>

<span class="n">moduleload</span>      <span class="n">back_bdb</span><span class="o">.</span><span class="n">la</span>
<span class="n">moduleload</span>      <span class="n">memberof</span><span class="o">.</span><span class="n">la</span>

<span class="n">pidfile</span>         <span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">openldap</span><span class="o">/</span><span class="n">slapd</span><span class="o">.</span><span class="n">pid</span>
<span class="n">argsfile</span>        <span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">openldap</span><span class="o">/</span><span class="n">slapd</span><span class="o">.</span><span class="n">args</span>

<span class="n">database</span>        <span class="n">bdb</span>
<span class="n">suffix</span>          <span class="s2">&quot;o=example,c=ru&quot;</span>
<span class="n">rootdn</span>          <span class="s2">&quot;cn=root,o=example,c=ru&quot;</span>
<span class="n">rootpw</span>          <span class="n">secret</span>
<span class="n">directory</span>       <span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ldap</span>

<span class="n">overlay</span>                 <span class="n">memberof</span>
<span class="n">memberof</span><span class="o">-</span><span class="n">group</span><span class="o">-</span><span class="n">oc</span>       <span class="n">groupOfUniqueNames</span>
<span class="n">memberof</span><span class="o">-</span><span class="n">member</span><span class="o">-</span><span class="n">ad</span>      <span class="n">uniqueMember</span>
</code></pre></div>

<p>У меня сервер уже был заполнен под завязку, по этому для генерации нового атрибута потребовалось перезалить всю базу на сервер.
Делаем дамп текущей рабочей конфигурации</p>
<div class="highlight"><pre><span></span><code>ldapsearch -x -LLL -D &#39;cn=root,o=example,c=ru&#39; -w secret  -b &#39;o=example,c=ru&#39; &gt; /tmp/init.ldif
</code></pre></div>

<p>Чистим DIT</p>
<div class="highlight"><pre><span></span><code><span class="n">service</span> <span class="n">slapd</span> <span class="n">stop</span>
<span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ldap</span><span class="o">/*</span>
<span class="n">service</span> <span class="n">slapd</span> <span class="n">start</span>
</code></pre></div>

<p>Возвращаем все записи на исходную</p>
<div class="highlight"><pre><span></span><code>ldapmodify -a -v -x -D &#39;cn=root,o=example,c=ru&#39; -w sercret  -f /tmp/init.ldif
</code></pre></div>

<p>После чего проверяем наличие атрибута memberOf</p>
<div class="highlight"><pre><span></span><code>#ldapsearch -x -LL  -b &#39;o=example,c=ru&#39; &#39;(uid=user)&#39; memberOf
version: 1

dn: cn=NameSecond,ou=Sysadmins,ou=SoftwareDevelopment,ou=IT,ou=Accounts,o=
 example,c=ru
memberOf: cn=groupname,ou=WebApps,ou=Services,o=example,c=ru
</code></pre></div>

<p>Если все прошло успешно, переходим к настройке клиента</p>
<h2>Конфигурация клиента</h2>
<p>На стороне клиента нужно добавить фильтр для демона sssd. Делается это добавлением следующих опций в /etc/sssd/sssd.conf</p>
<div class="highlight"><pre><span></span><code>access_provider = ldap
ldap_access_filter = memberOf=cn=usergroup,ou=UnixShell,ou=Services,o=example,c=ru
</code></pre></div>

<p>Тем самым мы сообщаем серверу что нужно пропускать только тех пользователей, у которых доступен атрибут "memberOf" и его значение равно "cn=usergroup..."
Рабочий файл конфигурации у меня получился такой</p>
<div class="highlight"><pre><span></span><code><span class="k">[domain/default]</span>
<span class="na">ldap_uri</span> <span class="o">=</span> <span class="s">ldaps://ldap.example.ru</span>
<span class="na">ldap_tls_cacertdir</span> <span class="o">=</span> <span class="s">/etc/openldap/cacerts</span>
<span class="na">ldap_id_use_start_tls</span> <span class="o">=</span> <span class="s">True</span>
<span class="na">cache_credentials</span> <span class="o">=</span> <span class="s">False</span>
<span class="na">ldap_search_base</span> <span class="o">=</span> <span class="s">o=example,c=ru</span>
<span class="na">krb5_realm</span> <span class="o">=</span> <span class="s">EXAMPLE.COM</span>
<span class="na">krb5_server</span> <span class="o">=</span> <span class="s">kerberos.example.com</span>
<span class="na">id_provider</span> <span class="o">=</span> <span class="s">ldap</span>
<span class="na">auth_provider</span> <span class="o">=</span> <span class="s">ldap</span>
<span class="na">chpass_provider</span> <span class="o">=</span> <span class="s">ldap</span>
<span class="na">access_provider</span> <span class="o">=</span> <span class="s">ldap</span>
<span class="na">ldap_access_filter</span> <span class="o">=</span> <span class="s">memberOf=cn=usergroup,ou=UnixShell,ou=Services,o=example,c=ru</span>
<span class="k">[sssd]</span>
<span class="na">services</span> <span class="o">=</span> <span class="s">nss, pam</span>
<span class="na">config_file_version</span> <span class="o">=</span> <span class="s">2</span>
<span class="na">domains</span> <span class="o">=</span> <span class="s">default</span>
<span class="k">[nss]</span>
<span class="k">[pam]</span>
<span class="k">[sudo]</span>
<span class="k">[autofs]</span>
<span class="k">[ssh]</span>
<span class="k">[pac]</span>
</code></pre></div>

<p>Перезапускаем демона</p>
<div class="highlight"><pre><span></span><code>service sssd restart
</code></pre></div>

<p>[l01]: {% post_url 2014-03-21-openldap-tls %}</p>
    <h2>Comments</h2>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
       var disqus_shortname = 'srv-nix-com';
       var disqus_identifier = 'centos-sssd-i-openldap.html';
       var disqus_url = 'https://srv-nix.com/centos-sssd-i-openldap.html';
       (function() {
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] ||
             document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the comments.</noscript>
</article>
            </div>
        </div>


        <div id="sidebar">
            <h1><a href="https://srv-nix.com " title="title">YODA</a></h1>
            <span class="description"> </span>
            <!-- <span class="feed"><a href="">RSS</a> | <a href="">Atom</a></span> -->
        </div>

        <div id="footer">
            <nav>
                <ul>
                    <li>:: <a href="https://srv-nix.com/categories.html">Categories</a></li>
                    <li>:: <a href="https://srv-nix.com/tags.html">Tags</a></li>
                </ul>
            </nav>

            <div id="credits">
                <span>Adapted from <a href="http://wordpress.org/themes/monospace">Monospace</a> || Created with <a href="">Pelican</a></span>
            </div>
                
        </div>

<script type="text/javascript">
    var disqus_shortname = 'srv-nix-com';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

    </div>

</body>
</html>